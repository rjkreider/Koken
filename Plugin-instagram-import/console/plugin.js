Koken.extend(function(){function t(){!e&&s&&o("/media/recent",function(t){r(t)},["max_id="+s])}var i,n={},a=[],s=!1,e=!1,o=$.proxy(function(t,n,a){e=!0,t=t||"",a=a||[],a=a.length?"&"+a.join("&"):"";var o=this.data();$.ajax({url:"https://api.instagram.com/v1/users/"+o.user_id+t+"/?access_token="+o.access_token+a,jsonp:"callback",dataType:"jsonp",success:$.proxy(function(t){s=!(!t.pagination||!t.pagination.next_max_id)&&t.pagination.next_max_id,e=!1,n.call(this,t.data),i.update()},this)})},this),r=$.proxy(function(s){var e=this,o=0;$.each(s,function(t,i){$.inArray(i.id,a)===-1&&(o++,n[i.id]=i,$("<li/>").attr("data-instagram-id",i.id).append($("<span/>").addClass("image-wrap").append(i.likes.count?$("<span/>").addClass("plugin_img_badge").text("â™¥ "+i.likes.count):"").append($("<img/>").attr("src",i.images.thumbnail.url).css("height",150))).on("click",function(){$(this).toggleClass("selected"),e.validate(!!$("#instagram_import_api_list ul li.selected").length)}).addClass("loading clearfix").appendTo("#instagram_import_api_list ul"))}),"block"===$("#instagram_import_loading").css("display")&&($("#instagram_import_loading").hide(),$("#instagram_import_api_list").show()),$("#instagram_import_username").hide(),i.update(),o<20&&t(),$(window).trigger("resize")},this),c=$.proxy(function(){$("#instagram_import_api_list ul").empty(),i=this.scrollbar("inst-browse-middle-scroll"),i.listen("page",function(){t()}),this.sync({action:"imported_ids",method:"GET",context:this,finished:function(t){a=t,o(!1,function(t){t?($(".instagram-account-name").text(t.full_name),$(".instagram-account-avatar").attr("src",t.profile_picture),o("/media/recent",function(t){r(t)})):($("#instagram_import_loading").hide(),$("#instagram_import_username").show())})}})},this);this.event("import",$.proxy(function(){var t=$(".al-display:visible").length,i=this;if($("#instagram_import_by_url").is(":visible")){var a=this.notify().wait("Adding photo from Instagram"),s=Math.round((new Date).getTime()/1e3),e=function(t){ko.dataFor($("#content_subnav li:eq(1)").get(0)).settings.last_upload(s),i.reloadLibraryContent(),$.bbq.pushState($("#content_subnav span.label-inst").closest("a").attr("href").replace("#","")+"/selection:"+t.id+"/view:single",2),a.success('"'+t.title+'" added from Instagram.')};this.sync({action:"create",data:"url="+encodeURIComponent($("#valid_instagram_url").val())+"&visibility="+$("#upload_visibility").val(),context:this,finished:function(i){if(i.error)return a.warn(i.error),void $("#valid_instagram_url").focus();if(t){var n=this.get("album").album.id;this.sync({request:"albums/"+n+"/content/"+i.id,method:"POST",context:this,finished:function(){e(i)}})}else e(i)}})}else{var o=$("[data-instagram-id].selected").map(function(){return n[$(this).data("instagram-id")]}),a=this.notify().wait("Adding photo"+(o.length>1?"s":"")+" from Instagram"),e=function(t){a.success(t.length+" photo"+(t.length>1?"s":"")+" added from Instagram."),i.reloadLibraryContent(),$.bbq.pushState("",2),$.bbq.pushState($("#content_subnav span.label-inst").closest("a").attr("href").replace("#",""),2),c()};o.length&&this.sync({action:"create_api",data:"payload="+encodeURIComponent(JSON.stringify(o.toArray()))+"&visibility="+$("#upload_visibility").val(),context:this,finished:function(i){if(t){var n=this.get("album").album.id;this.sync({request:"albums/"+n+"/content/"+i.join(","),method:"POST",context:this,finished:function(){e(i)}})}else e(i)}})}},this)),this.hook("library.loaded",function(){this.render("koken.library.navigation",{title:"Instagram imports",url:"#/library/content/koken_instagram:1/visibility:any",icon_class:"label-inst"})}),this.hook("settings.edit.KokenInstagram",function(){var t=$("#instagramSettingsEditTop").html(),i=this.data(),n=this;this.render("koken.settings.edit.top",{html:t},function(){var t=$("#instagram-settings-target");i.user_id?o(!1,function(i){i?t.append($("<img />").attr("src",i.profile_picture)).append($('<span class="auth_name" />').text("  "+i.full_name)).append($("<button />").addClass("button tiny").text("Disconnect").attr("title","Disconnect plugin from this Instagram account").on("click",function(){n.sync({action:"revoke",method:"POST",context:this,finished:function(){t.html(l()),n.notify().success("Instagram account disconnected.")}})})):t.append(l())}):t.append(l())})});var l=$.proxy(function(){var t=this;return $("<button />").addClass("button sm").text("Connect").on("click",function(){var i=ko.dataFor($("#content_subnav li:eq(1)").get(0)).settings.uuid();t.sync({action:"auth",method:"POST",context:this,finished:function(t){location.href=this.config.paths.store+"/middleman/instagram/auth?uuid="+i+"&koken_redirect="+t.callback+"/to:settings"}})})},this),d=function(){var t=this.data(),i=$("#instagramImportSection").html();this.render("koken.sheet.section",{title:"Instagram",id:"import_content_inst",class:"import_inst",html:i},$.proxy(function(){$("#import_content_instagram input").val(""),$(".import_inst").parent().data("kguid",this.kguid),$("#instagram_import_by_url").hide(),t.access_token&&t.user_id?($("#instagram_import_loading").show(),c()):$("#instagram_import_username").show(),$(document).off(".kinstagram").on("keyup.kinstagram","#instagram-username",function(t){13===t.which&&(t.preventDefault(),$("#instagram-add-username").trigger("click"))}),$("#instagram-add-username").on("click",$.proxy(function(){this.notify().wait("Connecting to Instagram"),$("#instagram-add-username").addClass("progress").attr("disabled",!0),$("#instagram-username").attr("disabled",!0);var t=ko.dataFor($("#content_subnav li:eq(1)").get(0)).settings.uuid();return this.sync({action:"auth",method:"POST",context:this,finished:function(i){location.href=this.config.paths.store+"/middleman/instagram/auth?uuid="+t+"&koken_redirect="+i.callback}}),!1},this)),$(document).on("keyup paste","#instagram_import_by_url input:first",$.proxy(function(){requestAnimationFrame($.proxy(function(){var t=$("#instagram_import_by_url input:first"),i=t.val().trim(),n=/^http(s)?:\/\/(www.)?instagram.com\/.+$/.test(i);this.validate(n),n||!i.length?(t.removeClass("valerror"),t.siblings("span").hide()):(t.addClass("valerror"),t.siblings("span").show())},this))},this)),$(document).on("click","#instagram-switch-page",$.proxy(function(){return this.validate(!1),$("#instagram_import_by_url").show(),$("#instagram_import_api_list").hide(),!1},this)),$(document).on("click","#instagram-switch-list",$.proxy(function(){return $("#instagram_import_by_url").hide(),$("#instagram_import_api_list").show(),this.validate(!!$("#instagram_import_api_list ul li.selected").length),!1},this))},this))},m=function(t){$("#view_select").append('<option class="inst_opt" value="content/koken_instagram:1">Instagram imports</option>')};this.hook("sheet.activated",function(t){var i=this;switch($("option.inst_opt").remove(),t.id()){case"import_content":d.call(i,t);break;case"shortcode_media":"photo"===t.type()&&m.call(i,t)}}),this.route("library","import/instagram",function(){this.sheet("import_content").display()})});