Koken.extend(function(){var e=function(e){var i=Math.floor(e/60),t=Math.floor(e%60);if(10>t&&(t="0"+t),i>60){var o=Math.floor(i/60);i=Math.floor(i%60),10>i&&(i="0"+i),i=o+":"+i}return i+":"+t},i=$.proxy(function(){this.sync({action:"candidates",method:"GET",context:this,finished:function(i){var t=this;$("#vimeo_import_api_list ul").empty(),$(".vimeo-account-name").text(i.account.display_name),$(".vimeo-account-avatar").attr("src",i.account.portrait_small),$.each(i.videos,function(i,o){$("<li/>").attr("data-vimeo-id",o.id).append($("<span/>").addClass("image-wrap").append($("<span/>").addClass("plugin_img_badge").text(e(o.duration))).append($("<img/>").css("min-height",112).attr("src",o.thumbnail_medium))).append($("<span/>").addClass("title").text(o.title)).on("click",function(){$(this).toggleClass("selected"),t.validate($("#vimeo_import_api_list ul li.selected").length?!0:!1)}).addClass("loading clearfix").appendTo("#vimeo_import_api_list ul")}),$("#vimeo_import_username").hide(),$("#vimeo_import_loading").hide(),$("#vimeo_import_api_list").show(),t.scrollbar("vimeo-browse-middle-scroll").update(),$(window).trigger("resize")}})},this);this.event("import",$.proxy(function(){var e=$(".al-display:visible").length,t=this;if($("#vimeo_import_by_url").is(":visible")){var o=this.notify().wait("Adding video from Vimeo"),a=Math.round((new Date).getTime()/1e3),n=function(e){ko.dataFor($("#content_subnav li:eq(1)").get(0)).settings.last_upload(a),t.reloadLibraryContent(),$.bbq.pushState($("#content_subnav span.label-vimeo").closest("a").attr("href").replace("#","")+"/selection:"+e.id+"/view:single",2),o.success('"'+e.title+'" added from Vimeo.')};this.sync({action:"create",data:"url="+encodeURIComponent($("#import_content_vimeo input").val())+"&visibility="+$("#upload_visibility").val(),context:this,finished:function(i){if(i.error)return o.warn(i.error),$("#import_content_vimeo input").focus(),void 0;if(e){var t=this.get("album").album.id;this.sync({request:"albums/"+t+"/content/"+i.id,method:"POST",context:this,finished:function(){n(i)}})}else n(i)}})}else{var s=$("[data-vimeo-id].selected").map(function(){return $(this).data("vimeo-id")}),o=this.notify().wait("Adding video"+(s.length>1?"s":"")+" from Vimeo"),n=function(e){o.success(e.length+" video"+(e.length>1?"s":"")+" added from Vimeo."),t.reloadLibraryContent(),$.bbq.pushState("",2),$.bbq.pushState($("#content_subnav span.label-vimeo").closest("a").attr("href").replace("#",""),2),i()};s.length&&this.sync({action:"create_api",data:"ids="+s.toArray().join(",")+"&visibility="+$("#upload_visibility").val(),context:this,finished:function(i){if(e){var t=this.get("album").album.id;this.sync({request:"albums/"+t+"/content/"+i.join(","),method:"POST",context:this,finished:function(){n(i)}})}else n(i)}})}},this)),this.hook("library.loaded",function(){this.render("koken.library.navigation",{title:"Vimeo imports",url:"#/library/content/koken_vimeo:1/visibility:any",icon_class:"label-vimeo"})});var t=function(){var e=this.data(),t=$("#vimeoImportSection").html();this.render("koken.sheet.section",{title:"Vimeo",id:"import_content_vimeo","class":"import_vimeo",html:t,route:"upload/koken-vimeo-upload"},$.proxy(function(){$("#import_content_vimeo input").val(""),$(".import_vimeo").parent().data("kguid",this.kguid),$("#vimeo_import_by_url").hide(),e.username?($("#vimeo_import_loading").show(),i()):$("#vimeo_import_username").show(),$(document).off(".kvimeo").on("keyup.kvimeo","#vimeo-username",function(e){13===e.which&&(e.preventDefault(),$("#vimeo-add-username").trigger("click"))}),$("#vimeo-add-username").on("click",$.proxy(function(){$("#vimeo-add-username").addClass("progress").attr("disabled",!0),$("#vimeo-username").attr("disabled",!0);var e=this.notify().wait("Connecting to Vimeo");return this.save({username:$("#vimeo-username").val()},function(t){t===!0?(e.success("Connected to Vimeo"),i()):(e.warn("Incorrect account name. Please try again."),$("#vimeo_import_username p.plus").text("Incorrect account name. Please try again."),$("#vimeo-username").attr("disabled",!1).focus(),$("#vimeo-add-username").removeClass("progress").attr("disabled",!1))}),!1},this)),$(document).on("keyup paste","#vimeo_import_by_url input:first",$.proxy(function(){requestAnimationFrame($.proxy(function(){var e=$("#vimeo_import_by_url input:first"),i=e.val().trim(),t=/^http(s)?:\/\/(www.)?vimeo.com\/.+$/.test(i);this.validate(t),t||!i.length?(e.removeClass("valerror"),e.siblings("span").hide()):(e.addClass("valerror"),e.siblings("span").show())},this))},this)),$(document).on("click","#vimeo-switch-page",$.proxy(function(){return this.validate(!1),$("#vimeo_import_by_url").show(),$("#vimeo_import_api_list").hide(),!1},this)),$(document).on("click","#vimeo-switch-list",$.proxy(function(){return $("#vimeo_import_by_url").hide(),$("#vimeo_import_api_list").show(),this.validate($("#vimeo_import_api_list ul li.selected").length?!0:!1),!1},this))},this))},o=function(){$("#view_select").append('<option class="vimeo_opt" value="content/koken_vimeo:1">Vimeo imports</option>')};this.hook("sheet.activated",function(e){var i=this;switch($("option.vimeo_opt").remove(),e.id()){case"import_content":t.call(i,e);break;case"shortcode_media":"video"===e.type()&&o.call(i,e)}}),this.hook("selection.loaded",function(e){if(e){var i=e.html&&e.html.match(/src="([^"]+)"/),t=i?i[1].split("?"):[],o=this.data();if(t.length>1){var a=t[1];$.each(a.split("&"),function(e,i){var t=i.split("=");o[t[0]]="color"===t[0]?t[1].replace("#",""):Number(t[1])})}this.render("koken.library.sidebar",{sections:[{label:"Vimeo player",visibility:e.koken_vimeo,fields:[{label:"Show portrait on video",key:"portrait",type:"boolean",value:o.portrait},{label:"Show title on video",key:"title",type:"boolean",value:o.title},{label:"Show byline on video",key:"byline",type:"boolean",value:o.byline},{label:"Autoplay video",key:"autoplay",type:"boolean",value:o.autoplay},{label:"Loop video",key:"loop",type:"boolean",value:o.loop},{label:"Color",key:"color",type:"color",value:o.color}]}]},function(e,i){var t=this;$(document).off(".vimeoCheckboxSettings").on("change.vimeoCheckboxSettings","span.plugin_"+this.kguid,function(){requestAnimationFrame(function(){var e=[];$("span.plugin_"+t.kguid+' input[type="checkbox"]').each(function(i,t){e.push($(t).attr("name")+"="+($(t).is(":checked")?1:0))}),e.push("color="+$("#plugin_color").val().replace("#","")),e=e.join("&");var o=i.html.replace(/src="[^"]+"/,function(i){var t=i.match(/src="([^"\?]+)/);return'src="'+t[1]+"?"+e+'"'});i.save({html:o,console_html:o.replace("autoplay=1","autoplay=0")})})})})}})});